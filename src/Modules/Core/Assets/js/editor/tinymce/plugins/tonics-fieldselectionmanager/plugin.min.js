let fieldManagerXWidth = window.innerWidth || document.documentElement.clientWidth || document.getElementsByTagName('body')[0].clientWidth;
let fieldManagerYHeight = window.innerHeight || document.documentElement.clientHeight || document.getElementsByTagName('body')[0].clientHeight;
let fieldSelectionManagerURL = '/admin/tools/field/selection-manager'
let fieldSelectionInstanceAPI = null;

dataReceivedFromFieldManager = '';
let tabsCollatedFieldItemsJSONValue = null, tabsContainer = null;

function fieldSelectionManagerOnAction(editor) {
    /* Open window */
    fieldSelectionInstanceAPI = editor.windowManager.openUrl({
        title: 'Tonics Field Selection Manager',
        width: fieldManagerXWidth,
        height: fieldManagerYHeight,
        url: fieldSelectionManagerURL
    });
}

tinymce.PluginManager.add('tonics-fieldselectionmanager', function(editor, url) {
    editor.on('init', function (e) {
        editor.getBody().addEventListener('click', (e) => {
            let target = e.target;
            if (target.classList.contains('fieldsEdit')) {
                tabsContainer = target.closest('.tabs');
                if (tabsContainer) {
                    let tonicsFieldWrapper = tabsContainer.querySelector('.tonicsFieldWrapper');
                    let jsonValue = tonicsFieldWrapper.value;
                    /* Open window */
                    fieldSelectionInstanceAPI = tinymce.activeEditor.windowManager.openUrl({
                        title: 'Tonics Field Selection Manager',
                        width: fieldManagerXWidth,
                        height: fieldManagerYHeight,
                        url: fieldSelectionManagerURL
                    });
                    tabsCollatedFieldItemsJSONValue = jsonValue;
                }
            }
        });
    });

    /* Add a button that opens a window */
    editor.ui.registry.addButton('tonics-fieldselectionmanager', {
        icon: 'non-breaking',
        text: 'Field Manager',
        onAction: () => {
            fieldSelectionManagerOnAction(editor)
        }
    });

    // CONTEXT MENU
    editor.ui.registry.addMenuItem('tonics-fieldselectionmanager', {
        icon: 'non-breaking',
        text: 'Field Manager',
        onAction: () => {
            fieldSelectionManagerOnAction(editor)
        }
    });

    editor.ui.registry.addContextMenu('tonics-fieldselectionmanager', {
        update: function (element) {
            return 'tonics-fieldselectionmanager';
        }
    });

    editor.addCommand('tonics:OpenedFieldSelectionManager', function (ui, value, n) {
        fieldSelectionInstanceAPI.sendMessage({
            type: "tonics:FieldSelectedData",
            message: tabsCollatedFieldItemsJSONValue,
        });
    });

    editor.addCommand('tonics:FieldSelectedData', function (ui, value, n) {
        dataReceivedFromFieldManager = value;
        fieldSelectionInstanceAPI.close();
        if (tabsContainer){
            tabsContainer.outerHTML = dataReceivedFromFieldManager;
            tabsContainer = null;
        } else {
            tinymce.activeEditor.insertContent(dataReceivedFromFieldManager);
        }
    });

    /* Return the metadata for the help plugin */
    return {
        getMetadata: function () {
            return  {
                name: 'Field Selection Manager',
                url: ''
            };
        }
    };
});